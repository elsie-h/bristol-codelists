nchar('325278007')
nchar('19525211000001103')
install.packages('tidyverse')
library(tidyverse)
install.packages("googlesheets4")
library(googlesheets4)
read_sheet("https://docs.google.com/spreadsheets/d/17kFDRLAvezsJRLeQiBRPujcB9MfuVKv-LeQNLJ-lS-Y/edit#gid=57957362")
?read_sheet
codelist <- read_sheet("https://docs.google.com/spreadsheets/d/17kFDRLAvezsJRLeQiBRPujcB9MfuVKv-LeQNLJ-lS-Y/edit#gid=57957362",
sheet = "codelist")
codelist
codelist$code
unlist(codelist$code)
codelist
codelist$code <- unlist(codelist$code)
codelist
codelist %>% filter(name %in% 'cancer')
codelist %>% filter(name %in% 'cancer', terminology %in% 'snomed')
codelist %>% filter(name %in% 'cancer', terminology %in% 'SNOMED')
codelist %>% filter(name %in% 'cancer', terminology %in% 'SNOMED') %>% View()
codelist %>% filter(str_detect(code, '\.'))
codelist %>% filter(str_detect(code, '\\.'))
codelist %>% filter(str_detect(code, '\\.')) %>% distinct(terminology)
codelist <- read_sheet("post-covid-bristol",
sheet = "codelist")
codelist <- read_sheet("post-covid-bristol-copy",
sheet = "codelist")
codelist <- read_sheet("https://docs.google.com/spreadsheets/d/1-ZZk_UnFnnrgWVg_n1GV1orWPyX_zwgFtskioDWUQ-w/edit#gid=57957362",
sheet = "codelist")
codelist
codelist <- read_sheet("https://docs.google.com/spreadsheets/d/1-ZZk_UnFnnrgWVg_n1GV1orWPyX_zwgFtskioDWUQ-w/edit#gid=57957362",
sheet = "codelist",
col_types = 'char')
codelist <- read_sheet("https://docs.google.com/spreadsheets/d/1-ZZk_UnFnnrgWVg_n1GV1orWPyX_zwgFtskioDWUQ-w/edit#gid=57957362",
sheet = "codelist",
col_types = 'c')
codelist %>% filter(name %in% 'cancer', terminology %in% 'SNOMED') %>% View()
codelist <- read_sheet("https://docs.google.com/spreadsheets/d/1-ZZk_UnFnnrgWVg_n1GV1orWPyX_zwgFtskioDWUQ-w/edit#gid=57957362",
sheet = "codelist")
codelist %>% filter(name %in% 'cancer', terminology %in% 'SNOMED') %>% View()
rm(list = ls())
codelists <- read_sheet("https://docs.google.com/spreadsheets/d/1-ZZk_UnFnnrgWVg_n1GV1orWPyX_zwgFtskioDWUQ-w/edit#gid=57957362",
sheet = "codelist")
# code column as list because of different cell types in googlesheet
# unlist to convert all to character
# do not specify character in "col_types" arg of "read_sheet" due to handling of scientific notation
codelists$code <- unlist(codelists$code)
codelists
# name and terminology columns in lowercase
codelists <- codelists %>%
mutate_at('name', 'terminology', tolower)
?mutate
# name and terminology columns in lowercase
codelists <- codelists %>%
mutate(across(vars(c('name', 'terminology'))), tolower)
# name and terminology columns in lowercase
codelists <- codelists %>%
mutate(across(c(name, terminology), tolower))
codelists
# sort by name, terminology, code
codelists <- codelists %>%
arrange(name, terminology, code)
codelists
# view distinct names
codelists %>%
distinct(name)
# view distinct names
codelists %>%
distinct(name) %>%
unlist()
# view distinct names
codelists %>%
distinct(name) %>%
unlist() %>% unname()
codelists %>% filter(name %in% 'ami_covariate_only')
codelists %>% filter(str_detect(name, "covariate"))
codelists %>% filter(str_detect(name, "covariate")) %>% distinct(name) %>% unlist
codelists %>% filter(name %in% "dvt_icvt_covariate_only" )
codelists %>% filter(name %in% "dvt_icvt_covariate_only" ) %>% select("term")
codelists %>% filter(name %in% "dvt_icvt" )
codelists %>% filter(name %in% "dvt_icv" ) %>% View
codelists %>% filter(str_detect(name,"dvt_icv")) %>% View
# ami_covariate_only as ami_prior
codelists %>%
mutate(across(name,
~ case_when(. %in% "ami_covariate_only"
~ "ami_prior",
. %in% c("dvt_icvt_covariate_only",
"pe_covariate_only",
"stroke_sah_hs_covariate_only",
"tcp_covariate_only",
"vt_covariate_only")
~ str_remove(., "_covariate_only"),
TRUE ~ .)))
codelists %>% distinct(terminology)
codelists %>% filter(terminology %in% "ctv3_snomedmapped")
codelists %>% filter(terminology %in% "ctv3_snomedmapped")
codelists %>% filter(terminology %in% "ctv3_snomedmapped") %>% print(n=Inf)
codelists %>%
mutate(across(name,
# ami_covariate only seems to refer to prior ami
~ case_when(. %in% "ami_covariate_only"
~ "ami_prior",
# all the rest seem to just differ by terminology, which will be added as a suffix anyway
. %in% c("dvt_icvt_covariate_only",
"pe_covariate_only",
"stroke_sah_hs_covariate_only",
"tcp_covariate_only",
"vt_covariate_only")
~ str_remove(., "_covariate_only"),
TRUE ~ .))) %>%
mutate(across(terminology,
~ case_when(. %in% "ctv3_snomedmapped" ~ "snomed",
TRUE ~ .))) %>%
mutate(across(name,
~ str_c(., terminology, sep = '_')))
distinct(codelists, name)
distinct(codelists, name)$name
codelists
# sort out covariate_only names and add terminology as suffix
codelists <- codelists %>%
mutate(across(name,
# ami_covariate only seems to refer to prior ami
~ case_when(. %in% "ami_covariate_only"
~ "ami_prior",
# all the rest seem to just differ by terminology, which will be added as a suffix anyway
. %in% c("dvt_icvt_covariate_only",
"pe_covariate_only",
"stroke_sah_hs_covariate_only",
"tcp_covariate_only",
"vt_covariate_only")
~ str_remove(., "_covariate_only"),
TRUE ~ .))) %>%
mutate(across(terminology,
~ case_when(. %in% "ctv3_snomedmapped" ~ "snomed",
TRUE ~ .))) %>%
mutate(across(name,
~ str_c(., terminology, sep = '_')))
distinct(codelists, name)$name
codelists <- read_sheet("https://docs.google.com/spreadsheets/d/1-ZZk_UnFnnrgWVg_n1GV1orWPyX_zwgFtskioDWUQ-w/edit#gid=57957362",
sheet = "codelist")
# code column as list because of different cell types in googlesheet
# unlist to convert all to character
# do not specify character in "col_types" arg of "read_sheet" due to handling of scientific notation
codelists$code <- unlist(codelists$code)
# name and terminology columns in lowercase
codelists <- codelists %>%
mutate(across(c(name, terminology), tolower))
# sort by name, terminology, code
codelists <- codelists %>%
arrange(name, terminology, code)
# view distinct names
codelists %>%
distinct(name) %>%
unlist() %>% unname()
# cleaning
codelists <- codelists %>%
# sort out covariate_only names and add terminology as suffix
mutate(across(name,
# ami_covariate only seems to refer to prior ami
~ case_when(. %in% "ami_covariate_only"
~ "ami_prior",
# all the rest seem to just differ by terminology, which will be added as a suffix anyway
. %in% c("dvt_icvt_covariate_only",
"pe_covariate_only",
"stroke_sah_hs_covariate_only",
"tcp_covariate_only",
"vt_covariate_only")
~ str_remove(., "_covariate_only"),
TRUE ~ .))) %>%
mutate(across(terminology,
~ case_when(. %in% "ctv3_snomedmapped" ~ "snomed",
TRUE ~ .))) %>%
# add terminology as suffix
mutate(across(name,
~ str_c(., terminology, sep = '_'))) %>%
# remove "." from codes for upload to OpenSAFELY
mutate(across(code,
~ str_remove(., "\\.")))
codelists
get_wd()
getwd()
file.path("OneDrive - University of Bristol", "codelists", "lists")
setwd("~/OneDrive - University of Bristol/codelists/scripts")
?file.path
file.path("~", "OneDrive - University of Bristol", "codelists", "lists")
setwd("~/OneDrive - University of Bristol/codelists")
for (i in distinct(codelists, name)$name[1:5]) {
codelists %>%
filter(name %in% i) %>%
select(code) %>%
write_csv(file = file.path("~", "OneDrive - University of Bristol", "codelists", "lists", str_c(i, ".csv")),
append = FALSE,
col_names = FALSE)
}
# write all codes for each distinct name to a csv file for upload to OpendSAFELY
for (i in distinct(codelists, name)$name) {
codelists %>%
filter(name %in% i) %>%
select(code) %>%
write_csv(file = file.path("~", "OneDrive - University of Bristol", "codelists", "lists", str_c(i, ".csv")),
append = FALSE,
col_names = FALSE)
}
library(readr)
cancer_snomed_orig <- read_csv("cancer_snomed.csv")
cancer_snomed_new <- read_csv("lists/cancer_snomed.csv")
cancer_snomed_orig
cancer_snomed_new
cancer_snomed_orig <- read_csv("cancer_snomed.csv", col_names = F)
cancer_snomed_new <- read_csv("lists/cancer_snomed.csv", col_names = F)
cancer_snomed_orig <- read_csv("cancer_snomed.csv", col_names = F)
cancer_snomed_orig
all(sort(unlist(cancer_snomed_orig)) == sort(unlist(cancer_snomed_new)))
library(tidyverse)
library(googlesheets4)
codelists <- read_sheet("https://docs.google.com/spreadsheets/d/1-ZZk_UnFnnrgWVg_n1GV1orWPyX_zwgFtskioDWUQ-w/edit#gid=57957362",
sheet = "codelist")
# code column as list because of different cell types in googlesheet
# unlist to convert all to character
# do not specify character in "col_types" arg of "read_sheet" due to handling of scientific notation
codelists$code <- unlist(codelists$code)
# name and terminology columns in lowercase
codelists <- codelists %>%
mutate(across(c(name, terminology), tolower))
# sort by name, terminology, code
codelists <- codelists %>%
arrange(name, terminology, code)
# view distinct names
codelists %>%
distinct(name) %>%
unlist() %>% unname()
# cleaning
codelists <- codelists %>%
# sort out covariate_only names and add terminology as suffix
mutate(across(name,
# ami_covariate only seems to refer to prior ami
~ case_when(. %in% "ami_covariate_only"
~ "ami_prior",
# all the rest seem to just differ by terminology, which will be added as a suffix anyway
. %in% c("dvt_icvt_covariate_only",
"pe_covariate_only",
"stroke_sah_hs_covariate_only",
"tcp_covariate_only",
"vt_covariate_only")
~ str_remove(., "_covariate_only"),
TRUE ~ .))) %>%
mutate(across(terminology,
~ case_when(. %in% "ctv3_snomedmapped" ~ "snomed",
TRUE ~ .))) %>%
# add terminology as suffix
mutate(across(name,
~ str_c(., terminology, sep = '_'))) %>%
# remove "." from codes for upload to OpenSAFELY
mutate(across(code,
~ str_remove(., "\\.")))
i <- 'liver_disease_snomed'
codelists %>%
filter(name %in% i) %>%
select(code) %>%
write_csv(file = file.path("~", "OneDrive - University of Bristol", "codelists", "lists", str_c(i, ".csv")),
append = FALSE,
col_names = FALSE)
